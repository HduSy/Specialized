Created Dateï¼š2024-01-20 15:38:56  
Last Modifiedï¼š2024-01-20 15:38:56

# Tags

# Content

## 4.1 å“åº”å¼æ•°æ®ä¸å‰¯ä½œç”¨å‡½æ•°

å‰¯ä½œç”¨å‡½æ•°ï¼š`effect` å‡½æ•°çš„æ‰§è¡Œï¼Œç›´æ¥æˆ–é—´æ¥å½±å“äº†å…¶ä»–å‡½æ•°çš„æ‰§è¡Œï¼Œè¿™æ—¶å‡½æ•°äº§ç”Ÿäº†å‰¯ä½œç”¨  
å“åº”å¼æ•°æ®ï¼šå€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œç›¸å…³çš„ `effect` å‡½æ•°è‡ªåŠ¨é‡æ–°æ‰§è¡Œ

## 4.2 å“åº”å¼æ•°æ®çš„åŸºæœ¬å®ç°

- å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œæ—¶ï¼Œä¼šè§¦å‘å€¼çš„è¯»å– `get` æ“ä½œ
- è®¾ç½®å€¼æ—¶ï¼Œä¼šè§¦å‘å€¼çš„è®¾ç½® `set` æ“ä½œ  

å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œæ—¶ï¼Œæ¶‰åŠå€¼çš„ `get` æ“ä½œï¼Œå°†å‰¯ä½œç”¨å‡½æ•°å­˜å…¥â€œæ¡¶â€ä¸­ï¼š  
![[Pasted image 20240123141622.png]]  
è®¾ç½®/æ›´æ–°å€¼æ—¶ï¼Œæ¶‰åŠå€¼çš„ `set` æ“ä½œï¼Œå°†å‰¯ä½œç”¨å‡½æ•°ä»â€æ¡¶â€œä¸­å–å‡ºå¹¶æ‰§è¡Œï¼š  
![[Pasted image 20240123141823.png]]  
ä»£ç ï¼š

```js
const bucket = new Set(); // æ¡¶
const data = { text: 'Hello World' }; // åŸå§‹æ•°æ®
function effect() {
  document.getElementById('txt').innerText = data.text;
}
new Proxy(data, {
  // è¯»å–æ“ä½œ
  get(target, key) {
    bucket.add(effect); // åŠ å…¥æ¡¶é‡Œ
    return target[key];
  },
  // ä¿®æ”¹æ“ä½œ
  set(target, key, value) {
    target[key] = value;
    bucket.forEach((fn) => fn());
    return true;
  }
});
```

## 4.3 è®¾è®¡ä¸€ä¸ªå®Œå–„çš„å“åº”ç³»ç»Ÿ

### å…¨å±€æ³¨å†Œ `activeEffect` ä½¿å¾—ä¸å†ä¾èµ–å‰¯ä½œç”¨å‡½æ•°çš„å…·ä½“åå­—

```ts
let activeEffect // å…¨å±€å˜é‡å­˜å‚¨è¢«æ³¨å†Œçš„effect
const bucket = new Set() // å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„â€œæ¡¶â€
// é‡æ„4.2èŠ‚effectå‡½æ•°åŠŸèƒ½: æ³¨å†Œå¹¶æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°, ç›¸æ¯”äºç¡¬ç¼–ç effectå, æ”¯æŒåŒ¿åå‡½æ•°ã€ä¸åŒå‡½æ•°å, ä¸ä¾èµ–å‰¯ä½œç”¨å‡½æ•°çš„åå­—äº†
function installEffect(fn) {
  activeEffect = fn
  fn()
}
const data = { text: 'Hello Vuejs!' } // åŸå§‹æ•°æ®

installEffect(() => {
  document.body.innerText = obj.text
})

const obj = new Proxy(data, {
  // æ‹¦æˆªè¯»å–æ“ä½œ
  get(target, key) {
    if(activeEffect) {
      bucket.add(activeEffect) // effectæ·»åŠ åˆ°æ¡¶
    }
    return target[key] // è¿”å›å±æ€§å€¼
  },
  set(target, key, val) {
    target[key] = val // è®¾ç½®å±æ€§å€¼
    bucket.forEach(fn => fn()) // å–å‡ºeffectå¹¶æ‰§è¡Œ
    return true
  }
})
```

### ğŸŒ²æ ‘å½¢ç»“æ„

```ts
effect(function effectFn() {
  document.body.innerText = obj.text
})
// å­˜åœ¨å…³ç³»
target Proxyä»£ç†çš„ç›®æ ‡å¯¹è±¡
    â””â”€â”€ key è¢«æ“ä½œçš„å­—æ®µå
        â””â”€â”€ effectFn è¯¥å€¼å¯¹åº”çš„å‰¯ä½œç”¨å‡½æ•°
```

- è¢«æ“ä½œï¼ˆè¯»å–ï¼‰çš„ä»£ç†å¯¹è±¡ `obj`ï¼›
- è¢«æ“ä½œï¼ˆè¯»å–ï¼‰çš„å­—æ®µå `text`ï¼›
- ä½¿ç”¨ effect å‡½æ•°æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•° `effectFn`ï¼›

#### ä¸åŒå‰¯ä½œç”¨å‡½æ•°æ“ä½œåŒä¸€å±æ€§

```ts
effect(function effectFn1() {
  obj.text
})
effect(function effectFn2() {
  obj.text
})
// å…³ç³»ç»“æ„
target
    â””â”€â”€ text
        â””â”€â”€ effectFn1
        â””â”€â”€ effectFn2
```

#### åŒä¸€å‰¯ä½œç”¨å‡½æ•°æ“ä½œä¸åŒå±æ€§

```ts
effect(function effectFn() {
  obj.text1
  obj.text2
})
// å¯¹åº”å…³ç³»
target
    â””â”€â”€ text1
        â””â”€â”€ effectFn
    â””â”€â”€ text2
        â””â”€â”€ effectFn
```

#### ä¸åŒå‰¯ä½œç”¨å‡½æ•°æ“ä½œä¸åŒå±æ€§

```ts
effect(function effectFn1() {
  obj1.text1
})
effect(function effectFn2() {
  obj2.text2
})
target1
    â””â”€â”€ text1
        â””â”€â”€ effectFn1
target2
    â””â”€â”€ text2
        â””â”€â”€ effectFn2
```

### å®ç°

**ç›®æ ‡ï¼šåœ¨å‰¯ä½œç”¨å‡½æ•°ä¸è¢«æ“ä½œçš„ç›®æ ‡å­—æ®µä¹‹é—´å»ºç«‹æ˜ç¡®çš„è”ç³»**

```ts
/**
 * æ ¹æœ¬åŸå› æ˜¯ï¼Œæˆ‘ä»¬æ²¡æœ‰åœ¨å‰¯ä½œç”¨å‡½æ•°ä¸è¢«æ“ä½œçš„ç›®æ ‡å­—æ®µä¹‹é—´å»ºç«‹æ˜ç¡®çš„è”ç³»ï¼Œæ‹¦æˆªäº†å¯¹æ‰€æœ‰å±æ€§çš„æ“ä½œï¼
 * å½“è¯»å–å±æ€§æ—¶ï¼Œæ— è®ºè¯»å–çš„æ˜¯å“ªä¸€ä¸ªå±æ€§ï¼Œå…¶å®éƒ½ä¸€æ ·ï¼Œéƒ½ä¼šæŠŠå‰¯ä½œç”¨å‡½æ•°æ”¶é›†åˆ°â€œæ¡¶â€é‡Œï¼›
 * å½“è®¾ç½®å±æ€§æ—¶ï¼Œæ— è®ºè®¾ç½®çš„æ˜¯å“ªä¸€ä¸ªå±æ€§ï¼Œä¹Ÿéƒ½ä¼šæŠŠâ€œæ¡¶â€é‡Œçš„å‰¯ä½œç”¨å‡½æ•°å–å‡ºå¹¶æ‰§è¡Œ
 * è®¾è®¡ä¸€ä¸ªæ ‘å½¢ç»“æ„
 * åŒä¸€å±æ€§å¯èƒ½å¯¹åº”å¤šä¸ªä¸åŒçš„å‰¯ä½œç”¨å‡½æ•°ï¼›
 * åŒä¸€å‰¯ä½œç”¨å‡½æ•°å¯èƒ½åŒæ—¶è¯»å–äº†å¤šä¸ªæ ‘å½¢
 * target --> keys --> effectFns
 */

const bucket2 = new WeakMap()
const obj2 = new Proxy(data, {
  get(target, key) {
    if(!activeEffect) return target[key] // æ²¡æœ‰effectç›´æ¥è¿”å›
    let depsMap = bucket2.get(target) // Map: target ---> keys map
    if(!depsMap) bucket2.set(target, depsMap = new Map())
    let deps = depsMap.get(key) // Set: key ---> effectFns set
    if(!deps) depsMap.set(key, deps = new Set())
    deps.add(activeEffect)
    return target[key]
  },
  set(target, key, val) {
    target[key] = val
    const depsMap = bucket2.get(target) // Map: target ---> keys map
    if(!depsMap) return false
    const effectFns = depsMap.get(key) // Set: key ---> effectFns set
    effectFns && effectFns.forEach(fn => fn())
    return true
  }
})
```

![[Pasted image 20240124102159.png]]

# Reference
