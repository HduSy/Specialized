创建日期：2022-06-01 14:42:57  
最后修改：2022-06-01 14:42:56

- - -
> When you learn, teach. When you get, give.  
>—<cite>Maya Angelou</cite>

# 正文

## Yarn

### Resolution

关于 `package.json` 中 `resolutions` 的配置项使用，[resolutions 替换二进制文件镜像地址](https://segmentfault.com/a/1190000021168459)，一些二进制文件并不能通过修改源地址为镜像地址来规避，而且自主编译的成功率也低得多，也就是说通过这种方式 yarn、npm 拿它也没办法。查看源码，会发现安装完后额外使用二进制文件编译的模块多使用 [bin-wrapper](https://www.npmjs.com/package/bin-wrapper) 执行下载和编译。如 `pngquant-bin`：

```javascript install.js
'use strict';  
const path = require('path');  
const BinWrapper = require('bin-wrapper');  
const pkg = require('../package.json');  
  
const url = `https://raw.githubusercontent.com/imagemin/pngquant-bin/v${pkg.version}/vendor/`;  
  
module.exports = new BinWrapper()  
 .src(`${url}macos/pngquant`, 'darwin')  
 .src(`${url}linux/x86/pngquant`, 'linux', 'x86')  
 .src(`${url}linux/x64/pngquant`, 'linux', 'x64')  
 .src(`${url}freebsd/x64/pngquant`, 'freebsd', 'x64')  
 .src(`${url}win/pngquant.exe`, 'win32')  
 .dest(path.resolve(__dirname, '../vendor'))  
 .use(process.platform === 'win32' ? 'pngquant.exe' : 'pngquant');
```

于是乎，如果在这之前，把下载地址替换成镜像地址，问题便迎刃而解了。[bin-wrapper-china](https://github.com/best-shot/bin-wrapper-china) 的解决思路就是如此。配合 `yarn` 的 `resolutions` 功能，安装时指定特定模块。

```json package.json
"resolutions": {  
  "bin-wrapper": "npm:bin-wrapper-china"  
}
```

## Pnpm

### 介绍

#### 项目初衷

节省磁盘空间；提升安装速度。

- 依赖被安装在基于内容寻址的存储中，不存在多个重复拷贝；
- 依赖项不同版本的包，只会将差异文件添加到仓库；
- 依赖文件会存储到磁盘某一位置，安装已有依赖会硬链接到这一位置，不占用额外磁盘空间。

#### 创建非扁平化 node_modules 目录结构

诀窍一：node 会解析符号连接，如 `.pnpm/express@4.17.1/node_modules/express` 去寻找依赖真正所在位置。`.pnpm/` 文件夹（虚拟存储目录）中平铺着依赖，解决了 `npm v2` 依赖长路径问题，同时避免 `npm v3+` 及 `yarn v1` 安全问题，保留了包之间的隔离；

诀窍二：依赖包与依赖项的实际位置位于同一目录级别，比如 `express` 依赖项都存放在 `.pnpm/express@4.17.1/node_modules` 下，与 `express` 同级，避免了循环软链。

> [!info]+  
`peer` 依赖会特殊点处理…

#### 基于符号链接的 node_modules 结构

pnpm 的 `node_modules` 布局使用符号链接来创建依赖项的嵌套结构，只有真正在依赖项中的包才能访问。当你安装依赖后，pnpm 将在 `node_modules` 创建依赖对应硬链接。

## 参考文献

[一个pnpm安装express目录结构的参考](https://github.com/zkochan/comparing-node-modules/tree/master/pnpm5-example)
