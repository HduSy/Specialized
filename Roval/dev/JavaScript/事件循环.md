Created Date：2024-01-22 11:20:36  
Last Modified：2024-01-22 11:20:36

# Tags

[[事件处理]] [[../DOM/DOM#事件模型/事件机制/事件流|DOM]]

# Content

浏览器中执行 `JS` 代码的主线程/`JS引擎` 是单线程的，同时只能有一个任务在执行。同步任务进入**执行栈**依次执行，异步任务完成后的回调进入**任务队列**，执行栈中的同步任务执行完毕后，会检查任务队列中是否有异步已完成的回调，推入执行栈执行。  

异步任务又分为 `Task` 与 `Job`，即宏任务与微任务。微任务优先级较宏任务大，且执行过程中产生的微任务同样在本轮 Event-Loop 中执行，待所有微任务执行完毕后，执行一个宏任务。  
宏任务执行完毕后，在执行下一个宏任务之前，仍要先将其对应的所有微任务执行完，方可执行宏任务。

## 过程

1. 检查 `Macrotask` 队列是否为空，若不为空，则进行下一步，若为空，则跳到 3；
2. 从 `Macrotask` 队列中取队首 (在队列时间最长) 的任务进去执行栈中执行 (仅仅一个)，执行完后进入下一步；
3. 检查 `Microtask` 队列是否为空，若不为空，则进入下一步，否则，跳到 1（开始新的事件循环）；
4. 从 `Microtask` 队列中取队首 (在队列时间最长) 的任务进去事件队列执行，执行完后，跳到 3 其中，在执行代码过程中新增的；`microtask` 任务**会在当前事件循环周期内执行**，而新增的 `macrotask` 任务只能等到**下一个事件循环**才能执行了；

## 机制

- 异步任务分为宏任务和微任务；
- 所有微任务执行完毕才会去执行宏任务；
- 下一个宏任务执行前先检查是否有微任务；

![[Pasted image 20240122112636.png]]

```ad-tip
- 一个 Event Loop 可以有一个或多个事件队列，但是只有一个微任务队列。
- 微任务队列全部执行完会重新渲染一次
- 每个宏任务执行完都会重新渲染一次
- requestAnimationFrame 处于渲染阶段，不在微任务队列，也不在宏任务队列
```

## 宏任务与微任务

**macro-task 宏任务** 大概包括：

- script(整体代码)
- `setTimeout`
- `setInterval`
- `setImmediate`(Node 环境)
- `I/O` 事件队列
- `UI render`

**micro-task 微任务** 大概包括:

- `process.nextTick`(Node 环境)
- `Promise.then/catch/finally`
- `async/await`(实际就是 promise)
- `queueMicrotask`
- `MutationObserver`(html5 新特性)
- `requestAnimationFrame`(有争议，处于渲染阶段，不在微任务队列，也不在宏任务队列)
- `Object.observe`(已废弃)

# Reference

[彻底搞懂JavaScript事件循环  - 掘金](https://juejin.cn/post/6992167223523541023)
